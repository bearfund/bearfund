openapi: 3.0.3
info:
  title: GamerProtocol API - Games & Lobbies
  version: 1.0.0
  description: Game management, matchmaking, and lobby endpoints for the GamerProtocol platform.

servers:
  - url: https://api.gamerprotocol.io/v1
    description: Production API
  - url: https://staging-api.gamerprotocol.io/v1
    description: Staging API

security:
  - BearerAuth: []
    ClientKey: []

paths:
  /games:
    get:
      summary: List user's games
      description: Get paginated list of authenticated user's active and recent games.
      operationId: listGames
      tags:
        - Game Management
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
        - name: status
          in: query
          description: Filter by game status
          schema:
            type: string
            enum: [pending, active, completed, forfeited]
      responses:
        '200':
          description: Games list retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /games/{gameUlid}:
    get:
      summary: Get game state
      description: Retrieve current state of a specific game by ULID.
      operationId: getGame
      tags:
        - Game Management
      parameters:
        - $ref: '#/components/parameters/GameUlidParam'
      responses:
        '200':
          description: Game state retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/{gameUlid}/action:
    post:
      summary: Execute game action
      description: Submit a player action to the game engine.
      operationId: executeAction
      tags:
        - Game Management
      parameters:
        - $ref: '#/components/parameters/GameUlidParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GameActionRequest'
            examples:
              validateFour:
                summary: Validate Four - Drop piece
                value:
                  action_type: drop_piece
                  action_details:
                    column: 3
              checkers:
                summary: Checkers - Move piece
                value:
                  action_type: move
                  action_details:
                    from: [2, 3]
                    to: [3, 4]
      responses:
        '200':
          description: Action executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameActionResponse'
        '400':
          $ref: '#/components/responses/InvalidAction'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/{gameUlid}/history:
    get:
      summary: Get game action history
      description: Retrieve complete action history for game replay.
      operationId: getGameHistory
      tags:
        - Game Management
      parameters:
        - $ref: '#/components/parameters/GameUlidParam'
      responses:
        '200':
          description: Action history retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameHistoryResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/{gameUlid}/options:
    get:
      summary: Get valid actions
      description: Get list of valid actions for current game state.
      operationId: getGameOptions
      tags:
        - Game Management
      parameters:
        - $ref: '#/components/parameters/GameUlidParam'
      responses:
        '200':
          description: Valid actions retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameOptionsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/{gameUlid}/forfeit:
    post:
      summary: Forfeit game
      description: Concede the game, awarding win to opponent.
      operationId: forfeitGame
      tags:
        - Game Management
      parameters:
        - $ref: '#/components/parameters/GameUlidParam'
      responses:
        '200':
          description: Game forfeited successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/quickplay:
    post:
      summary: Join quickplay queue
      description: Enter matchmaking queue for quick public match.
      operationId: joinQuickplay
      tags:
        - Matchmaking
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuickplayRequest'
      responses:
        '202':
          description: Successfully joined queue
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      game_title:
                        type: string
                      game_mode:
                        type: string
                  message:
                    type: string
                    example: Successfully joined the queue
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'

    delete:
      summary: Leave quickplay queue
      description: Exit matchmaking queue before match is found.
      operationId: leaveQuickplay
      tags:
        - Matchmaking
      responses:
        '204':
          description: Successfully left queue
        '401':
          $ref: '#/components/responses/Unauthorized'

  /games/quickplay/accept:
    post:
      summary: Accept quickplay match
      description: Confirm acceptance of found match.
      operationId: acceptQuickplay
      tags:
        - Matchmaking
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - match_id
              properties:
                match_id:
                  type: string
      responses:
        '202':
          description: Match accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/lobbies:
    get:
      summary: List available lobbies
      description: Get paginated list of public lobbies.
      operationId: listLobbies
      tags:
        - Lobbies
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
        - name: game_title
          in: query
          description: Filter by game title
          schema:
            type: string
      responses:
        '200':
          description: Lobbies list retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: Create lobby
      description: Create a new private or public lobby.
      operationId: createLobby
      tags:
        - Lobbies
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLobbyRequest'
      responses:
        '201':
          description: Lobby created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'

  /games/lobbies/{lobbyUlid}:
    get:
      summary: Get lobby details
      description: Retrieve details of a specific lobby.
      operationId: getLobby
      tags:
        - Lobbies
      parameters:
        - $ref: '#/components/parameters/LobbyUlidParam'
      responses:
        '200':
          description: Lobby details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete/leave lobby
      description: Delete lobby (if host) or leave lobby (if player).
      operationId: deleteLobby
      tags:
        - Lobbies
      parameters:
        - $ref: '#/components/parameters/LobbyUlidParam'
      responses:
        '204':
          description: Lobby deleted or left successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/lobbies/{lobbyUlid}/ready-check:
    post:
      summary: Initiate ready check
      description: Start ready check for all players in lobby (host only).
      operationId: startReadyCheck
      tags:
        - Lobbies
      parameters:
        - $ref: '#/components/parameters/LobbyUlidParam'
      responses:
        '200':
          description: Ready check initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/lobbies/{lobbyUlid}/players:
    post:
      summary: Add player to lobby
      description: Join lobby as a player.
      operationId: joinLobby
      tags:
        - Lobbies
      parameters:
        - $ref: '#/components/parameters/LobbyUlidParam'
      responses:
        '201':
          description: Joined lobby successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/lobbies/{lobbyUlid}/players/{username}:
    put:
      summary: Update player status
      description: Update player's ready status in lobby.
      operationId: updateLobbyPlayer
      tags:
        - Lobbies
      parameters:
        - $ref: '#/components/parameters/LobbyUlidParam'
        - name: username
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [waiting, ready, not_ready]
      responses:
        '200':
          description: Player status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LobbyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Remove player from lobby
      description: Kick player from lobby (host only) or leave lobby.
      operationId: removeLobbyPlayer
      tags:
        - Lobbies
      parameters:
        - $ref: '#/components/parameters/LobbyUlidParam'
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Player removed successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/{gameUlid}/rematch:
    post:
      summary: Request rematch
      description: Request rematch with same opponent after game completion.
      operationId: requestRematch
      tags:
        - Rematch
      parameters:
        - $ref: '#/components/parameters/GameUlidParam'
      responses:
        '201':
          description: Rematch requested
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RematchResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/rematch/{requestId}/accept:
    post:
      summary: Accept rematch
      description: Accept a rematch request.
      operationId: acceptRematch
      tags:
        - Rematch
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Rematch accepted, game starting
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /games/rematch/{requestId}/decline:
    post:
      summary: Decline rematch
      description: Decline a rematch request.
      operationId: declineRematch
      tags:
        - Rematch
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Rematch declined
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ClientKey:
      type: apiKey
      in: header
      name: X-Client-Key

  parameters:
    GameUlidParam:
      name: gameUlid
      in: path
      required: true
      description: Game ULID identifier
      schema:
        type: string
        pattern: '^[0-9A-Z]{26}$'

    LobbyUlidParam:
      name: lobbyUlid
      in: path
      required: true
      description: Lobby ULID identifier
      schema:
        type: string
        pattern: '^[0-9A-Z]{26}$'

    PageParam:
      name: page
      in: query
      description: Page number for pagination
      schema:
        type: integer
        minimum: 1
        default: 1

    PerPageParam:
      name: per_page
      in: query
      description: Items per page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    Game:
      type: object
      required:
        - ulid
        - game_title
        - state
        - players
        - created_at
      properties:
        ulid:
          type: string
          description: Game ULID identifier
        game_title:
          type: string
          description: Game title slug
        state:
          type: string
          enum: [pending, active, completed, forfeited]
          description: Current game state
        players:
          type: array
          items:
            type: string
          description: Array of player usernames
        current_player:
          type: string
          nullable: true
          description: Username of current player
        winner:
          type: string
          nullable: true
          description: Username of winner (null if not completed)
        game_state:
          type: object
          additionalProperties: true
          description: Game-specific state data
        last_action_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of last action
        created_at:
          type: string
          format: date-time
          description: Game creation timestamp
        completed_at:
          type: string
          format: date-time
          nullable: true
          description: Game completion timestamp

    GameListResponse:
      allOf:
        - $ref: '#/components/schemas/PaginatedResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Game'

    GameResponse:
      type: object
      required:
        - data
      properties:
        data:
          $ref: '#/components/schemas/Game'
        message:
          type: string

    GameActionRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          description: Action type/name
        parameters:
          type: object
          additionalProperties: true
          description: Action parameters (varies by game and action)

    GameActionResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          properties:
            action:
              $ref: '#/components/schemas/GameAction'
            game:
              $ref: '#/components/schemas/Game'
            next_action_deadline:
              type: string
              format: date-time
        message:
          type: string

    GameAction:
      type: object
      required:
        - ulid
        - player
        - action
        - created_at
      properties:
        ulid:
          type: string
          description: Action ULID
        player:
          type: string
          description: Username of player who performed action
        action:
          type: string
          description: Action type/name
        parameters:
          type: object
          additionalProperties: true
          description: Action parameters
        created_at:
          type: string
          format: date-time

    GameHistoryResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/GameAction'

    GameOptionsResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          properties:
            valid_actions:
              type: array
              items:
                type: string
            metadata:
              type: object
              additionalProperties: true

    Lobby:
      type: object
      required:
        - ulid
        - game_title
        - host_username
        - players
        - max_players
        - is_public
        - ready_check_active
        - created_at
      properties:
        ulid:
          type: string
        game_title:
          type: string
        host_username:
          type: string
        players:
          type: array
          items:
            $ref: '#/components/schemas/LobbyPlayer'
        max_players:
          type: integer
        is_public:
          type: boolean
        ready_check_active:
          type: boolean
        created_at:
          type: string
          format: date-time

    LobbyPlayer:
      type: object
      required:
        - username
        - status
        - joined_at
      properties:
        username:
          type: string
        status:
          type: string
          enum: [waiting, ready, not_ready]
        joined_at:
          type: string
          format: date-time

    LobbyListResponse:
      allOf:
        - $ref: '#/components/schemas/PaginatedResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Lobby'

    LobbyResponse:
      type: object
      required:
        - data
      properties:
        data:
          $ref: '#/components/schemas/Lobby'
        message:
          type: string

    CreateLobbyRequest:
      type: object
      required:
        - game_title
      properties:
        game_title:
          type: string
        is_public:
          type: boolean
          default: false
        max_players:
          type: integer
          minimum: 2
          maximum: 8

    QuickplayRequest:
      type: object
      required:
        - game_title
      properties:
        game_title:
          type: string
        game_mode:
          type: string
          default: standard

    RematchResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            ulid:
              type: string
            original_game_ulid:
              type: string
            status:
              type: string
              enum: [pending, accepted, declined, expired]
            expires_at:
              type: string
              format: date-time

    PaginatedResponse:
      type: object
      required:
        - data
        - links
        - meta
      properties:
        links:
          $ref: '#/components/schemas/PaginationLinks'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    PaginationLinks:
      type: object
      properties:
        first:
          type: string
          nullable: true
        last:
          type: string
          nullable: true
        prev:
          type: string
          nullable: true
        next:
          type: string
          nullable: true

    PaginationMeta:
      type: object
      properties:
        current_page:
          type: integer
        from:
          type: integer
          nullable: true
        last_page:
          type: integer
        path:
          type: string
        per_page:
          type: integer
        to:
          type: integer
          nullable: true
        total:
          type: integer

    ErrorResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
        error_code:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string

  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InvalidAction:
      description: Invalid game action
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

tags:
  - name: Game Management
    description: Game state and action management
  - name: Matchmaking
    description: Quickplay matchmaking
  - name: Lobbies
    description: Private lobby management
  - name: Rematch
    description: Rematch system
